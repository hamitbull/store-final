<!DOCTYPE html>
<html lang="ha">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mhyasi Store</title>
  <meta name="theme-color" content="#6A0DAD"/>
  <style>
    :root{--accent1:#6a11cb;--accent2:#2575fc;--panel:#fff;--fg:#0f172a}
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff}
    header{padding:12px 18px;display:flex;justify-content:space-between;align-items:center}
    main{padding:18px;max-width:1100px;margin:18px auto;display:grid;grid-template-columns:1fr 420px;gap:16px}
    .panel{background:var(--panel);color:var(--fg);border-radius:12px;padding:14px}
    input,button,select,textarea{padding:8px;border-radius:8px;border:1px solid #e6e9ef}
    .btn{background:linear-gradient(90deg,var(--accent2),var(--accent1));color:white;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn-alt{background:#fff;color:#111;border:1px solid #e6e9ef}
    .small{font-size:13px;color:#64748b}
    table{width:100%;border-collapse:collapse}
    th,td{padding:6px;border-bottom:1px solid #eef2f7}
    @media(max-width:980px){main{grid-template-columns:1fr}}
    #summaryPanel div{margin:6px 0;font-weight:700}
    .muted{color:#64748b;font-size:13px}
    .txt-muted{color:#6b7280;font-size:13px}
  </style>
</head>
<body>
  <header>
    <div style="font-weight:700">ðŸŒŠ Mhyasi Store</div>
    <div id="authControls"></div>
  </header>

  <main>
    <div>
      <!-- SUMMARY -->
      <div class="panel" id="summaryPanel" style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>ðŸ’° Total Sold: <span id="totalSoldText">â‚¦0</span></div>
        <div>ðŸ“¦ Stock Value: <span id="stockValueText">â‚¦0</span></div>
      </div>

      <!-- PROFILE -->
      <div class="panel" id="profilePanel">
        <div style="display:flex;align-items:center;gap:12px">
          <img id="shopLogo" src="" alt="logo" style="width:72px;height:72px;border-radius:12px;object-fit:cover;display:none"/>
          <div style="flex:1">
            <div style="font-weight:700" id="shopName">Not logged</div>
            <div class="small" id="shopAddress">â€”</div>
          </div>
          <div><button class="btn" id="btnProfile">Profile</button></div>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Products</div>
          <div class="small">Free: <b id="freeLimitText">5</b></div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px">
          <input id="pName" placeholder="Name" style="flex:1" />
          <input id="pPrice" placeholder="Price" type="number" style="width:110px" />
          <input id="pQty" placeholder="Qty" type="number" style="width:80px" />
          <button id="saveProductBtn" class="btn">Save</button>
        </div>

        <div style="margin-top:8px;max-height:320px;overflow:auto">
          <table id="productsTable">
            <thead><tr><th>Name</th><th>Price</th><th>Qty</th><th style="width:200px">Action</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- INVOICE HISTORY -->
      <div class="panel" style="margin-top:12px">
        <div style="font-weight:700">Invoice History</div>
        <div id="historyList" style="margin-top:8px;max-height:220px;overflow:auto"></div>
      </div>
    </div>

    <div>
      <div class="panel">
        <div style="font-weight:700">Cart</div>
        <div id="cartItems" style="margin-top:8px"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <input id="customerName" placeholder="Customer (optional)" style="flex:1" />
          <div style="min-width:140px;text-align:right">
            <div class="small">Total</div>
            <div id="cartTotal" style="font-weight:800">â‚¦0</div>
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="completeSaleBtn" class="btn">Complete Sale</button>
          <button id="printBtn" class="btn">Print</button>
          <button id="clearCartBtn" class="btn btn-alt">Clear</button>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Unlock & Admin</div>
          <div class="txt-muted">Requests â€¢ Codes â€¢ Admin actions</div>
        </div>

        <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <button id="btnRequest" class="btn">Request Unlock</button>
          <button id="btnEnterCode" class="btn btn-alt">Enter Code</button>
          <div style="display:flex;gap:8px">
            <button id="btnAdmin" class="btn btn-alt">Admin</button>
            <button id="btnMsgAdmin" class="btn">Message Admin</button>
          </div>
          <div class="muted" style="margin-top:6px">Note: WhatsApp admin number set in code.</div>
        </div>
      </div>
    </div>
  </main>

  <div id="modalRoot" style="display:none"></div>

<script>
/* CONFIG */
const API_BASE = "https://mhyasi2.onrender.com"; // backend URL
const ADMIN_PHONE = "+2349013025066";

let token = localStorage.getItem('mhyasi_token') || null;
let currentUser = JSON.parse(localStorage.getItem('mhyasi_user') || 'null') || null;
let products = [];
let cart = [];
let invoices = [];

/* HELPERS */
function $(s){ return document.querySelector(s); }
function toCurrency(n){ return "â‚¦" + Number(n||0).toLocaleString(); }
function showModal(html){ const r=document.getElementById('modalRoot'); r.style.display='block'; r.innerHTML = '<div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999"><div style="background:#fff;color:#000;padding:16px;border-radius:12px;max-width:96%;width:720px">'+html+'<div style="text-align:right;margin-top:12px"><button onclick="closeModal()" style="padding:8px">Close</button></div></div></div>'; }
function closeModal(){ const r=document.getElementById('modalRoot'); r.style.display='none'; r.innerHTML=''; }

/* AUTH UI */
function renderAuth(){
  const ctrl = $('#authControls');
  if(token && currentUser){
    ctrl.innerHTML = `<span style="margin-right:12px;font-weight:700">${currentUser.username}${currentUser.role==='admin'?' (admin)':''}</span><button id="btnLogout" class="btn btn-alt">Logout</button>`;
    $('#btnLogout').onclick = ()=>{ localStorage.removeItem('mhyasi_token'); localStorage.removeItem('mhyasi_user'); token=null; currentUser=null; products=[]; cart=[]; invoices=[]; renderAuth(); renderProfile(); renderProductsTable(); renderCart(); renderInvoices(); updateSummary(); };
  } else {
    ctrl.innerHTML = `<button id="btnLogin" class="btn btn-alt">Login</button> <button id="btnRegister" class="btn btn-alt">Register</button>`;
    $('#btnLogin').onclick = openLogin;
    $('#btnRegister').onclick = openRegister;
  }
}

/* PROFILE */
function renderProfile(){
  if(!currentUser){ $('#shopLogo').style.display='none'; $('#shopName').textContent='Not logged'; $('#shopAddress').textContent='â€”'; return; }
  $('#shopName').textContent = currentUser.shop_name || currentUser.username;
  $('#shopAddress').textContent = currentUser.shop_address || '';
  if(currentUser.logo_path){
    $('#shopLogo').src = API_BASE.replace(/\/$/,'') + currentUser.logo_path;
    $('#shopLogo').style.display = 'block';
  } else $('#shopLogo').style.display='none';
}

/* LOGIN / REGISTER */
function openRegister(){
  showModal(`<h3>Register</h3><div style="display:flex;gap:8px"><input id="regUser" placeholder="username" style="flex:1"/><input id="regPass" placeholder="password" type="password" style="width:200px"/></div><div style="margin-top:8px"><input id="regShop" placeholder="Shop name (optional)" style="width:100%"/><input id="regAddr" placeholder="Shop address (optional)" style="width:100%;margin-top:6px"/></div><div style="text-align:right;margin-top:8px"><button id="doReg" class="btn">Create</button></div>`);
  setTimeout(()=>{ $('#doReg').onclick = async ()=>{
    const u = $('#regUser').value.trim(), p = $('#regPass').value, s = $('#regShop').value, a = $('#regAddr').value;
    if(!u || !p) return alert('user & pass required');
    const res = await fetch(API_BASE + '/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p, shop_name: s, shop_address: a })});
    const j = await res.json();
    if(!j.ok) return alert(j.error || 'Failed');
    alert('Registered â€” please login');
    closeModal();
  }; },50);
}

function openLogin(){
  showModal(`<h3>Login</h3><div style="display:flex;gap:8px"><input id="loginUser" placeholder="username" style="flex:1"/><input id="loginPass" placeholder="password" type="password" style="width:200px"/></div><div style="text-align:right;margin-top:8px"><button id="doLogin" class="btn">Login</button></div>`);
  setTimeout(()=>{ $('#doLogin').onclick = async ()=>{
    const u = $('#loginUser').value.trim(), p = $('#loginPass').value;
    if(!u||!p) return alert('user & pass required');
    const res = await fetch(API_BASE + '/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username:u, password:p })});
    const j = await res.json();
    if(!j.ok) return alert(j.error || 'Login failed');
    token = j.token; currentUser = j.user; localStorage.setItem('mhyasi_token', token); localStorage.setItem('mhyasi_user', JSON.stringify(currentUser)); closeModal(); renderAuth(); renderProfile(); await loadProducts(); await loadInvoices(); updateSummary();
  }; },50);
}

/* PROFILE EDIT (upload logo) */
$('#btnProfile').onclick = ()=> {
  if(!currentUser) return openLogin();
  showModal(`<h3>Profile</h3><div><input id="shopNameInput" placeholder="Shop name" style="width:100%;margin-bottom:8px"/><input id="shopAddrInput" placeholder="Shop address" style="width:100%;margin-bottom:8px"/><div style="margin-top:8px"><label>Upload logo:</label><input type="file" id="logoFile"></div></div><div style="text-align:right;margin-top:8px"><button id="saveProfile" class="btn">Save</button></div>`);
  setTimeout(()=> {
    $('#shopNameInput').value = currentUser.shop_name || '';
    $('#shopAddrInput').value = currentUser.shop_address || '';
    $('#saveProfile').onclick = async ()=>{
      const sn = $('#shopNameInput').value.trim(), sa = $('#shopAddrInput').value.trim();
      await fetch(API_BASE + '/api/profile', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ shop_name: sn, shop_address: sa })});
      const f = $('#logoFile').files[0];
      if(f){
        const fd = new FormData(); fd.append('logo', f);
        const r = await fetch(API_BASE + '/api/profile/logo', { method:'POST', headers:{'Authorization':'Bearer '+token}, body: fd });
        const jr = await r.json();
        if(jr.ok) currentUser.logo_path = jr.logo_path;
      }
      // refresh me
      const me = await fetch(API_BASE + '/api/me', { headers: { 'Authorization': 'Bearer ' + token }});
      const jm = await me.json();
      if(jm.ok) currentUser = jm.user;
      localStorage.setItem('mhyasi_user', JSON.stringify(currentUser));
      closeModal(); renderProfile();
    };
  },50);
};

/* PRODUCTS CRUD */
$('#saveProductBtn').onclick = async ()=>{
  if(!currentUser) return openLogin();
  const name = $('#pName').value.trim(); const price = Number($('#pPrice').value)||0; const qty = Number($('#pQty').value)||0;
  if(!name) return alert('Enter name');
  const res = await fetch(API_BASE + '/api/products', { method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ name, price, qty })});
  const j = await res.json();
  if(!j.ok) return alert(j.error||'Error');
  $('#pName').value=''; $('#pPrice').value=''; $('#pQty').value='';
  await loadProducts(); updateSummary();
};

async function loadProducts(){
  if(!currentUser) { products = []; renderProductsTable(); updateSummary(); return; }
  const r = await fetch(API_BASE + '/api/products', { headers: { 'Authorization':'Bearer '+token }});
  const j = await r.json();
  products = j.ok ? j.products || [] : [];
  renderProductsTable();
  updateSummary();
}

function renderProductsTable(){
  const tbody = $('#productsTable tbody'); tbody.innerHTML='';
  products.forEach(p=>{
    const tr = document.createElement('tr');
    const pid = String(p.id);
    tr.innerHTML = `<td>${p.name}</td><td>${toCurrency(p.price)}</td><td>${p.qty}</td>
      <td>
        <button class="btn" onclick='addToCart("${pid}")'>Add</button>
        <button class="btn btn-alt" onclick='openEdit("${pid}")'>Edit</button>
        <button class="btn btn-alt" onclick='delProduct("${pid}")'>Del</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

window.openEdit = function(id){
  const p = products.find(x=>String(x.id)===String(id)); if(!p) return alert('Product not found');
  showModal(`<h3>Edit product</h3><div style="display:flex;gap:8px"><input id="eName" placeholder="name" value="${p.name}" style="flex:1"/><input id="ePrice" type="number" value="${p.price}" style="width:110px"/><input id="eQty" type="number" value="${p.qty}" style="width:80px"/></div><div style="text-align:right;margin-top:8px"><button id="doEdit" class="btn">Save</button></div>`);
  setTimeout(()=>{ $('#doEdit').onclick = async ()=>{
    const name = $('#eName').value.trim(), price = Number($('#ePrice').value)||0, qty = Number($('#eQty').value)||0;
    const res = await fetch(API_BASE + '/api/products/' + id, { method:'PUT', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify({ name, price, qty })});
    const j = await res.json();
    if(!j.ok) return alert(j.error||'Update failed');
    closeModal();
    await loadProducts(); updateSummary();
  }; },50);
};

window.delProduct = async function(id){
  if(!confirm('Delete product?')) return;
  await fetch(API_BASE + '/api/products/' + id, { method:'DELETE', headers: { 'Authorization':'Bearer '+token }});
  await loadProducts(); updateSummary();
};

/* CART */
window.addToCart = function(id){
  const p = products.find(x=>String(x.id)===String(id));
  if(!p) return alert('not found');
  if(p.qty <= 0) return alert('Out of stock');
  const exists = cart.find(c=>c.id == p.id);
  if(exists) exists.qty += 1; else cart.push({ id: p.id, name: p.name, price: p.price, qty: 1 });
  renderCart();
}
function renderCart(){ const wrap = $('#cartItems'); wrap.innerHTML=''; let total=0; cart.forEach((c,i)=>{ total += c.price * c.qty; const div = document.createElement('div'); div.style='display:flex;justify-content:space-between;align-items:center;padding:6px;border-bottom:1px solid #eee'; div.innerHTML = `<div>${c.name} x ${c.qty}</div><div>${toCurrency(c.price*c.qty)} <button onclick='removeCart(${i})' style="margin-left:8px">Remove</button></div>`; wrap.appendChild(div); }); $('#cartTotal').textContent = toCurrency(total); }
function removeCart(i){ cart.splice(i,1); renderCart(); }
$('#clearCartBtn').onclick = ()=>{ if(confirm('Clear cart?')){ cart=[]; renderCart(); } }

/* INVOICES */
async function loadInvoices(){
  if(!currentUser) { invoices = []; renderInvoices(); updateSummary(); return; }
  const r = await fetch(API_BASE + '/api/invoices', { headers: { 'Authorization':'Bearer '+token }});
  const j = await r.json();
  invoices = j.ok ? j.invoices || [] : [];
  renderInvoices(); updateSummary();
}
function renderInvoices(){
  const wr = $('#historyList'); wr.innerHTML=''; invoices.forEach(inv=>{
    const date = new Date((inv.created_at||Date.now())*1000).toLocaleString();
    const div = document.createElement('div'); div.style='padding:8px;border-bottom:1px solid #eee';
    div.innerHTML = `<div><b>${inv.invoice_id}</b> â€” ${date}</div><div>${toCurrency(inv.total)}</div><div style="margin-top:6px"><button class="btn" onclick='viewInvoice("${inv.invoice_id}")'>View/Print</button></div>`;
    wr.appendChild(div);
  });
}

window.viewInvoice = function(id){
  const inv = invoices.find(i => i.invoice_id === id || i.invoice_id == id);
  if(!inv) return alert('inv not found');
  // inv.items might be a JSON string or already array
  let items = [];
  try { items = typeof inv.items === 'string' ? JSON.parse(inv.items) : inv.items || []; } catch(e){ items = []; }
  let html = `<div style="font-weight:700;font-size:18px">${currentUser.shop_name || currentUser.username}</div><div>${currentUser.shop_address || ''}</div><hr><h3>Invoice ${inv.invoice_id}</h3><div>${new Date((inv.created_at||Date.now())*1000).toLocaleString()}</div><table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>`;
  items.forEach(it => html += `<tr><td>${it.name}</td><td>${it.qty}</td><td>${toCurrency(it.price)}</td><td>${toCurrency(it.qty*it.price)}</td></tr>`);
  html += `</tbody></table><div style="text-align:right;font-weight:800;margin-top:8px">Total: ${toCurrency(inv.total)}</div>`;
  const wnd = window.open('', '_blank'); wnd.document.write('<html><head><title>Invoice</title></head><body>'+html+'</body></html>'); wnd.document.close(); wnd.print();
};

/* COMPLETE SALE - post invoice then update each product qty */
$('#completeSaleBtn').onclick = async ()=>{
  if(cart.length === 0) return alert('Cart empty');
  if(!currentUser) return openLogin();
  const invoice_id = 'INV-' + Math.random().toString(36).slice(2,9).toUpperCase();
  const customer = $('#customerName').value.trim();
  const items = cart.map(c => ({ id: c.id, name: c.name, qty: c.qty, price: c.price }));
  const total = items.reduce((s,i)=>s + i.qty*i.price,0);

  // create invoice at backend
  const res = await fetch(API_BASE + '/api/invoices', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ invoice_id, customer, items, total })});
  const j = await res.json();
  if(!j.ok) return alert(j.error || 'Invoice save failed');

  // Update product qty on server and frontend â€” PUT sends full name,price,qty to avoid undefined overwrite
  for(const it of items){
    const prod = products.find(p => String(p.id) === String(it.id));
    if(!prod) continue;
    const newQty = Math.max(0, Number(prod.qty) - Number(it.qty));
    // send full object for safe update
    await fetch(`${API_BASE}/api/products/${prod.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
      body: JSON.stringify({ name: prod.name, price: prod.price, qty: newQty })
    });
    // update frontend copy
    prod.qty = newQty;
  }

  alert('Sale completed âœ…');
  cart = [];
  renderCart();
  renderProductsTable();
  await loadInvoices();
  await updateSummary();
};

/* PRINT current cart */
$('#printBtn').onclick = ()=>{
  if(cart.length===0) return alert('Cart empty');
  let html = `<div style="font-weight:700;font-size:18px">${currentUser?currentUser.shop_name: 'Mhyasi Store'}</div><div>${currentUser?currentUser.shop_address:''}</div><hr><h3>Invoice Preview</h3><table style="width:100%;border-collapse:collapse;margin-top:8px"><thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>`;
  cart.forEach(c=> html += `<tr><td>${c.name}</td><td>${c.qty}</td><td>${toCurrency(c.price)}</td><td>${toCurrency(c.price*c.qty)}</td></tr>`);
  html += `</tbody></table><div style="text-align:right;font-weight:800;margin-top:8px">Total: ${toCurrency(cart.reduce((s,i)=>s + i.qty*i.price,0))}</div>`;
  const wnd = window.open('','_blank'); wnd.document.write('<html><head><title>Invoice</title></head><body>'+html+'</body></html>'); wnd.document.close(); wnd.print();
};

/* REQUEST UNLOCK & REDEEM (simple UI) */
$('#btnRequest').onclick = ()=> {
  if(!currentUser) return openLogin();
  showModal(`<h3>Request Unlock</h3><div><input id="reqAmount" placeholder="Amount (â‚¦)" type="number" style="width:100%"/><textarea id="reqDetails" placeholder="Details (optional)" style="width:100%;margin-top:6px"></textarea></div><div style="text-align:right;margin-top:8px"><button id="doReq" class="btn">Send</button></div>`);
  setTimeout(()=>{ $('#doReq').onclick = async ()=>{
    const amt = Number($('#reqAmount').value) || 0; const details = $('#reqDetails').value || '';
    if(amt <= 0) return alert('enter amount');
    const r = await fetch(API_BASE + '/api/request', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ amount: amt, details })});
    const j = await r.json();
    if(!j.ok) return alert(j.error||'failed');
    alert('Request sent to admin');
    // open whatsapp to notify admin
    openWhatsAppToAdmin(`Unlock request from ${currentUser.username} â€” â‚¦${amt}. Details: ${details}`);
    closeModal();
  }; },50);
};

$('#btnEnterCode').onclick = ()=> {
  if(!currentUser) return openLogin();
  showModal(`<h3>Enter Unlock Code</h3><div><input id="codeInput" placeholder="CODE" style="width:100%"/></div><div style="text-align:right;margin-top:8px"><button id="doRedeem" class="btn">Redeem</button></div>`);
  setTimeout(()=>{ $('#doRedeem').onclick = async ()=>{
    const code = $('#codeInput').value.trim(); if(!code) return alert('enter code');
    const r = await fetch(API_BASE + '/api/redeem', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ code })});
    const j = await r.json();
    if(!j.ok) return alert(j.error||j.msg||'redeem failed');
    alert('Redeemed â€” account unlocked'); closeModal();
  }; },50);
};

/* ADMIN - basic panel (admin role required) */
$('#btnAdmin').onclick = async ()=> {
  if(!currentUser) return openLogin();
  if(currentUser.role !== 'admin') return alert('Admin only');
  const r1 = await fetch(API_BASE + '/api/requests', { headers: { 'Authorization':'Bearer '+token }});
  const j1 = await r1.json(); const reqs = j1.ok ? j1.requests : [];
  const r2 = await fetch(API_BASE + '/api/codes', { headers: { 'Authorization':'Bearer '+token }});
  const j2 = await r2.json(); const codes = j2.ok ? j2.codes : [];
  let html = `<h3>Admin Panel</h3><div style="display:flex;gap:12px"><div style="flex:1"><h4>Requests</h4>`;
  reqs.forEach(r=>{
    html += `<div style="border:1px solid #eee;padding:8px;margin-bottom:8px"><div><b>${r.username}</b> â€” â‚¦${r.amount}</div><div class="small">${r.details||''}</div><div style="text-align:right;margin-top:8px"><select id="dur_${r.id}"><option value="30">30 days</option><option value="90">3 months</option><option value="365">1 year</option></select> <button onclick="approveReq(${r.id})" class="btn">Approve</button> <button onclick="declineReq(${r.id})" class="btn btn-alt">Decline</button></div></div>`;
  });
  html += `</div><div style="flex:1"><h4>Codes</h4>`;
  codes.forEach(c=>{
    html += `<div style="border:1px solid #eee;padding:8px;margin-bottom:8px"><div><b>${c.code}</b> â€” for ${c.for_username || c.for_user}</div><div class="small">Until: ${c.until ? new Date(c.until).toLocaleString() : '-'}</div></div>`;
  });
  html += `</div></div>`;
  showModal(html);
  window.approveReq = async function(reqId){
    const durEl = document.getElementById('dur_'+reqId);
    const duration = Number(durEl.value || 30);
    const r = await fetch(API_BASE + '/api/approve', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ requestId: reqId, duration })});
    const j = await r.json(); if(!j.ok) return alert(j.error||'fail');
    alert('Approved. Code: ' + j.code);
    openWhatsAppToAdmin(`Approved request ${reqId}. Code: ${j.code}`);
    closeModal();
  };
  window.declineReq = async function(reqId){
    if(!confirm('Decline?')) return;
    const r = await fetch(API_BASE + '/api/decline', { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+token }, body: JSON.stringify({ requestId: reqId })});
    const j = await r.json(); if(!j.ok) return alert(j.error||'fail'); alert('Declined'); closeModal();
  };
};

/* WHATSAPP helper */
function openWhatsAppToAdmin(message){
  const phone = (ADMIN_PHONE||'').replace(/\D/g,'');
  if(!phone) return alert('Admin phone not configured');
  const msg = encodeURIComponent(message || 'Hello admin');
  const url = `https://wa.me/${phone}?text=${msg}`;
  window.open(url,'_blank');
}
$('#btnMsgAdmin').onclick = ()=> {
  if(!currentUser) return openLogin();
  openWhatsAppToAdmin(`Hello admin, this is ${currentUser.username}. Please assist.`);
};

/* SUMMARY */
async function updateSummary(){
  if(!token){ $('#totalSoldText').textContent = toCurrency(0); $('#stockValueText').textContent = toCurrency(0); return; }
  // stock value
  try {
    const pr = await fetch(API_BASE + '/api/products', { headers: { 'Authorization': 'Bearer ' + token }});
    const pj = await pr.json();
    let stock = 0;
    if(pj.ok && pj.products) pj.products.forEach(p => stock += Number(p.price||0) * Number(p.qty||0));
    $('#stockValueText').textContent = toCurrency(stock);
  } catch(e){}
  // total sold
  try {
    const ir = await fetch(API_BASE + '/api/invoices', { headers: { 'Authorization': 'Bearer ' + token }});
    const ij = await ir.json();
    let sold = 0;
    if(ij.ok && ij.invoices) ij.invoices.forEach(inv => sold += Number(inv.total||0));
    $('#totalSoldText').textContent = toCurrency(sold);
  } catch(e){}
}

/* INIT */
renderAuth();
renderProfile();
loadProducts();
loadInvoices();
updateSummary();
setInterval(updateSummary, 30000);
</script>
</body>
</html>
